#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
NC='\033[0m' # no color

current_shell=$(ps -p $(ps -p $$ -o ppid=) -o comm=)

# Get the history for new possible alias

useBashHistory(){
	declare -A counter

	# Extract last 2000 commands and save only the first word (the principal command)
	commands=$(tail -n 2000 ~/.bash_history | awk '{print $1}')

	# Command counter
	for command in $commands; do
	    ((counter[$command]++))
	done

	# Sort and show commands by quantity
	echo -e "\n🔁 Most frequent commands (last 2000 Bash history entries):\n"

	for command in "${!counter[@]}"; do
		number=${counter[$command]}

		if [[ number -gt 5 ]]
		then
	    		echo "$command: $number" >> most_words.txt
	    	fi
	done

	sort -h -t' ' -k2 most_words.txt | tail -n50
	rm -f most_words.txt
}


useZshHistory(){
	declare -A counter

	# Extact last used commands from ~/.zsh_history and save only the first word
	commands=$(sed 's/^: [0-9]*:[0-9]*;//' ~/.zsh_history | awk -F' ' '{print $1}' | grep -v '^[[:space:]]*$' | grep -v '^[[:punct:]]*$')

	# Command counter
	for command in $commands; do
	    ((counter[$command]++))
	done

	# Sort and show commands by quantity
	echo -e "\n🔁 Most used commands in zsh_history:\n"

	for command in "${!counter[@]}"; do
		number=${counter[$command]}

		if [[ number -gt 5 ]]
		then
	    		echo "$command: $number" >> most_words.txt
	    	fi
	done

	sort -h -t' ' -k2 most_words.txt | tail -n50
	rm -f most_words.txt
}

autoDetect(){
	current_shell=$(ps -p $(ps -p $$ -o ppid=) -o comm=)

	if [[ "$current_shell" == "zsh" ]];
	then
		echo -e "Using $current_shell history file..."
		useZshHistory
	elif [[ "$current_shell" == "bash" ]]; 
	then
		echo -e "Using $current_shell history file..."
		useBashHistory
	else
		echo -e "Unknown shell. Try using the manual mode "
	fi
}


# Get option history
echo -e "Welcome $USER to the Smart Alias program.
Choose how you want to load your command history:	"

echo -e "
1. Automatic (auto-detect your shell)
2. From ~/.bash_history
3. From ~/.zsh_history (Zsh users only)

'q' or 'Q' to Quit
"

echo -n "Enter option : "
read option

case $option in
	1)
	 sleep 1s
	 autoDetect
	;;
	2)
	 sleep 1s
	 useBashHistory
	;;
	3)
	 sleep 1s
	 useZshHistory
	;;
	"q" | "Q")
	 echo -e "Exiting..."
	 sleep 1s
	 exit 0
	;;
	*)
	 echo -e "Error, option not recognized"
	 exit 0
	;;
esac
